// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// NextAuth.js required models
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? @db.Text
  access_token             String? @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? @db.Text
  session_state            String?
  refresh_token_expires_in Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// User model with subscription info
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String? // For email/password authentication

  // Account Lockout (防暴力破解)
  failedLoginAttempts Int       @default(0)
  lastFailedLoginAt   DateTime?
  lockedUntil         DateTime?
  lockoutCount        Int       @default(0) // 累计锁定次数，用于渐进式锁定

  // Subscription
  plan               Plan                @default(free)
  stripeCustomerId   String?             @unique
  subscriptionId     String?             @unique
  subscriptionStatus SubscriptionStatus?

  // Trial
  trialStartedAt DateTime?
  trialEndsAt    DateTime?

  // API Access
  apiKeys ApiKey[]

  // Relations
  accounts     Account[]
  sessions     Session[]
  policies     Policy[]
  policyGroups PolicyGroup[]
  executions   Execution[]
  usageRecords UsageRecord[]
  teams        TeamMember[]
  ownedTeams   Team[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([stripeCustomerId])
}

enum Plan {
  free
  trial
  pro
  team
  enterprise
}

enum SubscriptionStatus {
  active
  past_due
  canceled
  incomplete
  incomplete_expired
  trialing
  unpaid
  paused
}

// API Keys for external access
model ApiKey {
  id         String    @id @default(cuid())
  userId     String
  name       String
  key        String    @unique // hashed
  prefix     String // first 8 chars for identification
  lastUsedAt DateTime?
  expiresAt  DateTime?
  revokedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([prefix])
}

// Policy Group - 多级分组支持
model PolicyGroup {
  id          String  @id @default(cuid())
  name        String
  description String?
  icon        String? // Lucide icon name
  sortOrder   Int     @default(0)

  // 自引用实现多级嵌套
  parentId String?
  parent   PolicyGroup?  @relation("GroupHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children PolicyGroup[] @relation("GroupHierarchy")

  // 关联策略
  policies Policy[]

  // 所有者（用户或团队级别）
  userId String?
  teamId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // 是否为系统预设分组
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([userId])
  @@index([teamId])
  @@index([sortOrder])
}

// Policy management
model Policy {
  id     String  @id @default(cuid())
  userId String
  teamId String?

  // 分组关联
  groupId String?
  group   PolicyGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  name        String
  description String?
  content     String  @db.Text
  version     Int     @default(1)
  isPublic    Boolean @default(false)
  shareSlug   String? @unique

  // PII detection results
  piiFields Json? // Array of detected PII fields

  // Soft delete (回收站)
  deletedAt    DateTime?
  deletedBy    String?
  deleteReason String?

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  team       Team?             @relation(fields: [teamId], references: [id], onDelete: SetNull)
  executions Execution[]
  versions   PolicyVersion[]
  recycleBin PolicyRecycleBin?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([teamId])
  @@index([groupId])
  @@index([shareSlug])
  @@index([deletedAt])
}

model PolicyVersion {
  id       String  @id @default(cuid())
  policyId String
  version  Int

  // 源码与哈希（安全架构扩展）
  content    String  @db.Text    // 保留兼容性
  source     String? @db.Text    // 新字段：策略源码
  sourceHash String?             // SHA-256(source)
  prevHash   String?             // 链式哈希，指向前一版本
  comment    String?             // 保留兼容性

  // 版本状态（安全架构扩展）
  status    PolicyVersionStatus @default(DRAFT)
  createdBy String?             // 创建者 ID

  // 多版本共存支持
  isDefault    Boolean   @default(false)  // 是否为默认执行版本
  releaseNote  String?   @db.Text         // 版本发布说明
  deprecatedAt DateTime?                  // 废弃时间
  deprecatedBy String?                    // 废弃操作人
  archivedAt   DateTime?                  // 归档时间
  archivedBy   String?                    // 归档操作人

  policy    Policy           @relation(fields: [policyId], references: [id], onDelete: Cascade)
  approvals PolicyApproval[]

  createdAt DateTime @default(now())

  @@unique([policyId, version])
  @@index([policyId])
  @@index([sourceHash])
  @@index([status])
  @@index([policyId, status])
  @@index([policyId, isDefault])
}

enum PolicyVersionStatus {
  DRAFT              // 草稿 - 编辑中
  PENDING_APPROVAL   // 待审批 - 已提交等待审批
  APPROVED           // 已批准 - 可执行
  REJECTED           // 已拒绝 - 不可执行
  DEPRECATED         // 已废弃 - 仍可执行但有警告
  ARCHIVED           // 已归档 - 不可执行，仅供审计
}

// 审批记录表（安全架构扩展）
model PolicyApproval {
  id         String           @id @default(cuid())
  versionId  String
  approverId String
  decision   ApprovalDecision
  comment    String?          @db.Text
  createdAt  DateTime         @default(now())

  version PolicyVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
  @@index([approverId])
  @@index([createdAt])
}

enum ApprovalDecision {
  APPROVED
  REJECTED
  REQUESTED_CHANGES
}

// Nonce 表（防重放攻击）
model UsedNonce {
  id        String   @id @default(cuid())
  nonce     String   @unique
  policyId  String?  // 关联的策略 ID
  userId    String?  // 使用者 ID
  usedAt    DateTime @default(now())
  expiresAt DateTime

  @@index([expiresAt])
  @@index([policyId])
}

// 安全事件日志
model SecurityEvent {
  id         String            @id @default(cuid())
  eventType  SecurityEventType
  severity   EventSeverity
  policyId   String?
  userId     String?
  ipAddress  String?
  userAgent  String?
  requestId  String?           // 请求追踪 ID
  details    Json
  createdAt  DateTime          @default(now())

  @@index([eventType])
  @@index([severity])
  @@index([policyId])
  @@index([createdAt])
}

enum SecurityEventType {
  SIGNATURE_INVALID           // 签名无效
  NONCE_REUSED                // Nonce 重放
  TIMESTAMP_EXPIRED           // 时间戳过期
  HASH_MISMATCH               // 哈希不匹配
  UNAUTHORIZED_APPROVAL       // 未授权审批
  SELF_APPROVAL_ATTEMPT       // 自审批尝试
  POLICY_EXECUTED             // 策略执行
  APPROVAL_DECISION           // 审批决策
  VERSION_CREATED             // 版本创建
  VERSION_NOT_FOUND           // 版本不存在
  DEPRECATED_VERSION_EXECUTED // 执行已废弃版本（警告）
  VERSION_SET_DEFAULT         // 设置默认版本
  VERSION_DEPRECATED          // 版本被废弃
  VERSION_ARCHIVED            // 版本被归档
}

enum EventSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// Policy Recycle Bin - 存储已删除策略的快照
model PolicyRecycleBin {
  id        String   @id @default(cuid())
  policyId  String   @unique
  userId    String
  snapshot  Json // 完整策略数据快照（包含 content, name, description, piiFields 等）
  deletedAt DateTime @default(now())
  deletedBy String // 删除操作的用户 ID
  expiresAt DateTime // deletedAt + 30天，用于定时清理任务

  policy Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// Policy execution tracking
model Execution {
  id       String @id @default(cuid())
  userId   String
  policyId String

  input      Json
  output     Json?
  error      String?
  durationMs Int
  success    Boolean

  // 策略版本追踪
  policyVersion Int? // 执行时的策略版本号

  // API vs Dashboard
  source   ExecutionSource @default(dashboard)
  apiKeyId String?

  // 执行日志增强
  metadata Json? // 额外元数据（IP 地址、用户代理、请求 ID 等）

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  policy Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([policyId])
  @@index([createdAt])
  @@index([success])
}

enum ExecutionSource {
  dashboard
  api
  playground
}

// Usage tracking for billing
model UsageRecord {
  id     String    @id @default(cuid())
  userId String
  type   UsageType
  count  Int       @default(1)
  period String // Format: YYYY-MM (e.g., "2024-12")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type, period])
  @@index([userId, period])
}

enum UsageType {
  execution
  pii_scan
  compliance_report
  api_call
}

// Team collaboration (Team plan)
model Team {
  id      String @id @default(cuid())
  name    String
  slug    String @unique
  ownerId String

  owner        User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members      TeamMember[]
  policies     Policy[]
  policyGroups PolicyGroup[]
  invitations  TeamInvitation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([slug])
}

model TeamMember {
  id     String   @id @default(cuid())
  teamId String
  userId String
  role   TeamRole @default(member)

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([userId])
}

enum TeamRole {
  owner
  admin
  member
  viewer
}

model TeamInvitation {
  id        String   @id @default(cuid())
  teamId    String
  email     String
  role      TeamRole @default(member)
  token     String   @unique
  expiresAt DateTime

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([teamId])
  @@index([email])
  @@index([token])
}

// Compliance Reports
model ComplianceReport {
  id        String         @id @default(cuid())
  userId    String
  type      ComplianceType
  title     String
  status    ReportStatus   @default(generating)
  data      Json? // Report data
  policyIds String[] // Policies included in report
  period    String? // e.g., "2024-Q4"

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([createdAt])
}

enum ComplianceType {
  gdpr
  hipaa
  soc2
  pci_dss
  custom
}

enum ReportStatus {
  generating
  completed
  failed
}

// Audit Log for enterprise
model AuditLog {
  id         String  @id @default(cuid())
  userId     String?
  teamId     String?
  action     String
  resource   String
  resourceId String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([teamId])
  @@index([createdAt])
  @@index([action])
}

// ============================================
// Demo 功能数据模型
// 用于展示 Aster Cloud 功能，与生产数据完全隔离
// ============================================

// Demo 会话 - 基于 Cookie 的匿名会话
model DemoSession {
  id        String   @id @default(cuid())
  sessionId String   @unique // Cookie 中的标识
  ipAddress String?
  userAgent String?
  expiresAt DateTime // 24小时后过期

  // 关联数据（级联删除）
  policies   DemoPolicy[]
  executions DemoExecution[]
  auditLogs  DemoAuditLog[]

  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@index([sessionId])
}

// Demo 策略
model DemoPolicy {
  id          String  @id @default(cuid())
  sessionId   String
  name        String
  description String?
  content     String  @db.Text
  version     Int     @default(1)

  // 示例输入数据（从 PolicyExample 复制）
  defaultInput Json?

  // PII 检测结果
  piiFields Json?

  // 关联
  session    DemoSession         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  versions   DemoPolicyVersion[]
  executions DemoExecution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
}

// Demo 策略版本历史
model DemoPolicyVersion {
  id       String  @id @default(cuid())
  policyId String
  version  Int
  content  String  @db.Text
  comment  String?

  policy    DemoPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@unique([policyId, version])
  @@index([policyId])
}

// Demo 策略执行记录
model DemoExecution {
  id        String @id @default(cuid())
  sessionId String
  policyId  String

  input      Json
  output     Json?
  error      String?
  durationMs Int
  success    Boolean

  session DemoSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  policy  DemoPolicy  @relation(fields: [policyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([policyId])
  @@index([createdAt])
}

// Demo 审计日志
model DemoAuditLog {
  id         String  @id @default(cuid())
  sessionId  String
  action     String // create_policy, update_policy, delete_policy, execute_policy
  resource   String // policy, execution
  resourceId String?
  metadata   Json?

  session   DemoSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@index([sessionId])
  @@index([createdAt])
  @@index([action])
}
